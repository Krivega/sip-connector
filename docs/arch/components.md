# Компоненты SIP Connector

Детальное описание всех менеджеров и их внутренних компонентов.

## ConnectionManager (SIP-соединения)

**Назначение**: Управление SIP-соединениями и регистрацией на сервере.

**Ключевые возможности**:

- Создание и управление SIP User Agent
- Регистрация/отмена регистрации на сервере
- Управление состояниями соединения через ConnectionStateMachine (XState)
- WebSocket соединения
- SIP-операции (OPTIONS, PING)
- Валидация переходов состояний с логированием

**Основные методы**:

- `connect()` / `disconnect()` - управление соединением
- `register()` / `unregister()` - регистрация на сервере
- `sendOptions()` / `ping()` - SIP-операции
- `checkTelephony()` - проверка телефонии

**Внутренние компоненты**:

- **ConnectionStateMachine** - управление состояниями SIP-соединения (XState)
  - Валидация переходов между состояниями
  - Публичный API с геттерами: `isIdle`, `isConnecting`, `isInitializing`, `isConnected`, `isRegistered`, `isDisconnected`, `isFailed`, `isPending`, `isPendingConnect`, `isPendingInitUa`, `isActiveConnection`
  - Типобезопасная обработка ошибок (error: Error | undefined)
  - Детальная информация об ошибках регистрации с status_code и reason_phrase
  - Методы: `reset()`, `startConnect()`, `startInitUa()`, `onStateChange()`, `canTransition()`, `getValidEvents()`
  - Автоматическое логирование всех переходов состояний

---

## ConnectionQueueManager (Очередь операций)

**Назначение**: Обеспечивает последовательное выполнение операций подключения.

**Ключевые возможности**:

- Предотвращение конфликтов между операциями
- Последовательное выполнение connect/disconnect
- Управление очередью через stack-promises

**Основные методы**:

- `connect()` / `disconnect()` - проксирование методов ConnectionManager
- `stop()` - остановка всех операций в очереди

**Принцип работы**: Все операции выполняются последовательно в очереди для предотвращения гонки условий.

---

## AutoConnectorManager (Автоматическое переподключение)

**Назначение**: Обеспечивает автоматическое переподключение.

**Ключевые возможности**:

- Автоматические попытки переподключения с задержками
- Проверка доступности телефонии
- Мониторинг состояния соединения
- Управление событиями попыток подключения

**Основные методы**:

- `start(parameters)` - запуск процесса автоподключения
- `stop()` - отмена текущей попытки автоподключения

---

## CallManager (WebRTC-звонки)

**Назначение**: Управление WebRTC-звонками через паттерн Стратегия.

**Ключевые возможности**:

- Исходящие и входящие звонки
- Управление WebRTC соединениями
- Управление медиа-потоками
- Поддержка различных протоколов
- Отслеживание изменений удаленных потоков через события
- Управление ролями участников (participant/spectator)
- Валидация переходов состояний через CallStateMachine

**Основные методы**:

- `startCall()` / `endCall()` - управление звонками
- `replaceMediaStream()` - замена медиа-потоков
- `restartIce()` - перезапуск соединения

**Внутренние компоненты**:

- **CallStateMachine** - управление состояниями звонка (XState)
  - Валидация переходов между состояниями
  - Публичный API с геттерами: `isIdle`, `isConnecting`, `isAccepted`, `isInCall`, `isEnded`, `isFailed`, `isPending`, `isActive`
  - Типобезопасная обработка ошибок (lastError: Error)
  - Метод `reset()` для перехода в начальное состояние
  - Предотвращение недопустимых переходов с логированием

- **MCUSession** - управление основным RTCSession для участников конференции
  - Создание и управление SIP-звонками через @krivega/jssip
  - Обработка событий peerconnection и track
  - Управление жизненным циклом звонка

- **RecvSession** - управление receive-only сессией для зрителей
  - Создание отдельного RTCPeerConnection для приема потоков
  - Поддержка receive-only transceiver'ов
  - Используется при перемещении участника в режим spectator

- **RemoteStreamsManager** (два экземпляра: main и recv)
  - **MainRemoteStreamsManager** - управление потоками для участников
  - **RecvRemoteStreamsManager** - управление потоками для зрителей
  - Группировка треков по участникам и потокам
  - Генерация событий `remote-streams-changed` при изменениях
  - Отслеживание окончания треков и автоматическая очистка

- **RoleManager** - управление ролями участника
  - Переключение между ролями: `participant`, `spectator`, `spectator_synthetic`
  - Выбор активного RemoteStreamsManager (main или recv)
  - Управление жизненным циклом RecvSession при смене роли

**Зависимости**:

- `ConferenceStateManager` - для хранения состояния звонка (number, answer)

---

## ConferenceStateManager (Состояние конференции)

**Назначение**: Централизованное хранение состояния конференции и звонка.

**Ключевые возможности**:

- Хранение данных конференции: room, participantName, channels, token (jwt), conference, participant
- Хранение данных звонка: number, answer (перенесены из callConfiguration)
- Реактивные обновления через систему событий
- Автоматическое обновление состояния при получении событий от ApiManager

**Основные методы**:

- `getState()` - получение readonly копии состояния
- `updateState(updates)` - обновление состояния с триггером события
- `reset()` - очистка состояния
- Геттеры для удобного доступа: `getToken()`, `getRoom()`, `getParticipantName()`, `getChannels()`, `getConference()`, `getParticipant()`, `getNumber()`, `getAnswer()`

**Интеграция**:

- Автоматически обновляется при получении событий от ApiManager:
  - `enterRoom` → обновляет `{ room, participantName }`
  - `conference:participant-token-issued` → обновляет `{ token: jwt, conference, participant }`
  - `channels` → обновляет `{ channels }`
- Используется CallManager для хранения данных звонка
- Используется SipConnector для передачи токена в API-запросы (sendOffer)

---

## ApiManager (Серверное API)

**Назначение**: Обработка SIP INFO сообщений и взаимодействие с сервером.

**Ключевые возможности**:

- Обработка команд от сервера
- Отправка состояния медиа
- Управление DTMF-сигналами
- Синхронизация каналов
- Обработка событий перемещения участников

**Основные методы**:

- `sendMediaState()` - отправка состояния медиа
- `sendDTMF()` - отправка DTMF-сигналов
- `waitChannels()` - ожидание каналов
- `askPermissionToEnableCam()` - запрос разрешений

---

## PresentationManager (Презентации)

**Назначение**: Управление демонстрацией экрана и презентациями.

**Ключевые возможности**:

- Запуск и остановка презентаций
- Обновление потоков презентации
- Управление битрейтом презентации
- Обработка дублированных вызовов
- Поддержка P2P и MCU режимов
- Валидация переходов состояний через PresentationStateMachine

**Основные методы**:

- `startPresentation()` / `stopPresentation()` - управление презентациями
- `updatePresentation()` - обновление потока
- `cancelSendPresentationWithRepeatedCalls()` - отмена операций

**Внутренние компоненты**:

- **PresentationStateMachine** - управление состояниями демонстрации экрана (XState)
  - Валидация переходов между состояниями
  - Публичный API с геттерами: `isIdle`, `isStarting`, `isActive`, `isStopping`, `isFailed`, `isPending`, `isActiveOrPending`
  - Типобезопасная обработка ошибок (lastError: Error | undefined)
  - Методы: `reset()`
  - Полное логирование всех переходов состояний

---

## IncomingCallManager (Входящие звонки)

**Назначение**: Обработка входящих SIP-звонков.

**Ключевые возможности**:

- Обнаружение входящих звонков
- Управление данными вызывающего
- Принятие и отклонение звонков
- Извлечение RTCSession для CallManager
- Валидация переходов состояний через IncomingCallStateMachine

**Основные методы**:

- `getIncomingRTCSession()` - получение сессии
- `declineToIncomingCall()` - отклонение звонка
- `busyIncomingCall()` - ответ "занято"

**Внутренние компоненты**:

- **IncomingCallStateMachine** - управление состояниями входящих SIP-звонков (XState)
  - Валидация переходов между состояниями
  - Публичный API с геттерами: `isIdle`, `isRinging`, `isConsumed`, `isDeclined`, `isTerminated`, `isFailed`, `isActive`, `isFinished`
  - Хранение данных вызывающего абонента (remoteCallerData)
  - Геттеры контекста: `remoteCallerData`, `lastReason`
  - Методы: `reset()`, `toConsumed()`
  - Полное логирование всех переходов состояний

---

## StatsManager (Статистика)

**Назначение**: Сбор и мониторинг WebRTC статистики.

**Ключевые возможности**:

- Сбор WebRTC статистики через StatsPeerConnection
- Мониторинг качества соединения
- Отслеживание доступной входящей пропускной способности
- Определение проблем с обработкой входящих фреймов

**Основные методы**:

- `availableIncomingBitrate` - получение доступной входящей пропускной способности
- `isInvalidInboundFrames` - проверка проблем с обработкой фреймов (пакеты приходят, но фреймы не обрабатываются)
- `isReceivingPackets` - проверка получения входящих пакетов

## MainStreamHealthMonitor (Мониторинг здоровья потока)

**Назначение**: Мониторинг здоровья основного входящего видеопотока.

**Ключевые возможности**:

- Обнаружение проблем с обработкой фреймов (пакеты приходят, но фреймы не обрабатываются)
- Проверка состояния основного видеотрека (muted)
- Оповещение при обнаружении проблем

**Основные методы**:

- `on()` - подписка на события

**Зависимости**:

- `StatsManager` - для получения статистики (геттер `isInvalidInboundFrames`)
- `CallManager` - для получения основного видеопотока (метод `getMainStream()`)

**Принцип работы**: Подписывается на сбор статистики от StatsManager. При обнаружении проблемы (пакеты приходят, но фреймы не обрабатываются) и если основной видеотрек находится в состоянии muted, оповещает об отсутствии входящих кадров.

---

## MainStreamRecovery (Восстановление потока)

**Назначение**: Автоматическое восстановление основного видеопотока при обнаружении проблем.

**Ключевые возможности**:

- Автоматический запуск renegotiate при обнаружении проблем
- Throttling запросов renegotiate (по умолчанию 3000ms)
- Предотвращение параллельных запросов renegotiate
- Автоматическая отмена операций при окончании звонка

**Основные методы**:

- `recover()` - запуск процесса восстановления потока

**Зависимости**:

- `CallManager` - для выполнения renegotiate (метод `renegotiate()`)

**Параметры конструктора**:

- `throttleRecoveryTimeout` - интервал throttling для предотвращения частых renegotiate (по умолчанию 3000ms)

**Принцип работы**: При вызове `recover()` выполняет throttled renegotiate через CallManager. Использует CancelableRequest для предотвращения параллельных запросов. Автоматически отменяет все операции при окончании звонка.

## VideoSendingBalancerManager (Балансировка видео)

**Назначение**: Автоматическая оптимизация видеопотоков.

**Ключевые возможности**:

- Автоматическая оптимизация видеопотоков с задержкой запуска (10 секунд)
- Адаптивное опрашивание изменений треков
- Управление параметрами кодирования
- Планирование и остановка балансировки
